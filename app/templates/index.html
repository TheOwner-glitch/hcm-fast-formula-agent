<!doctype html>
<html>
<head>
  <title>Fast Formula AI Agent</title>
  <style>
    .preset-btn {
      margin-left: 10px;
      font-size: 0.8em;
    }
    .result-container {
      margin-top: 30px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f9f9f9;
      white-space: pre-wrap;
    }
    .btn-group {
      margin-top: 10px;
    }
    .history-container {
      margin-top: 50px;
      padding: 10px;
      border-top: 2px solid #ccc;
    }
    .history-entry {
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }
    .history-entry summary {
      cursor: pointer;
      font-weight: bold;
    }
    .history-entry pre {
      white-space: pre-wrap;
      background: #f4f4f4;
      padding: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>Oracle HCM Fast Formula Agent</h1>

  <form method="POST" enctype="multipart/form-data">
    <label for="action"><strong>Select Action:</strong></label><br>
    <select name="action" id="action">
      <option value="generate">üÜï Generate ‚Äì Create a new Fast Formula from scratch</option>
      <option value="modify">‚úèÔ∏è Modify ‚Äì Change an existing Fast Formula based on a request</option>
      <option value="explain">üîç Explain ‚Äì Analyze and describe what a Fast Formula does</option>
      <option value="validate">‚ö†Ô∏è Validate ‚Äì Check for errors and logic issues in a formula</option>
    </select>
    <br><br>

    <label for="model"><strong>Select Model:</strong></label><br>
    <select name="model" id="model">
      <option value="gpt-4">üß† GPT-4 (default)</option>
      <option value="gpt-4o">‚ö° GPT-4o (faster, cheaper)</option>
      <option value="gpt-3.5-turbo">üöÄ GPT-3.5 Turbo (fastest & lowest cost)</option>
    </select>
    <br><br>

    <label>Formula Logic / Change Request:</label>
    <button type="button" class="preset-btn" onclick="loadPreset('generate')">Load Sample</button><br>
    <textarea name="logic" id="logic" rows="4" cols="80">{{ logic or '' }}</textarea><br><br>

    <label>Inputs (comma-separated):</label><br>
    <input type="text" name="inputs" id="inputs" value="{{ inputs or '' }}"/><br><br>

    <label>üìÑ Upload Fast Formula (.ff or .txt):</label><br>
    <input type="file" id="ffUpload" accept=".ff,.txt,text/plain"><br><br>

    <label>Paste Existing Formula (if modifying, explaining, or validating):</label>
    <button type="button" class="preset-btn" onclick="loadPreset('modify')">Modify Sample</button>
    <button type="button" class="preset-btn" onclick="loadPreset('explain')">Explain Sample</button>
    <button type="button" class="preset-btn" onclick="loadPreset('validate')">Validate Sample</button><br>
    <textarea name="original" id="original" rows="10" cols="80">{{ original or '' }}</textarea><br><br>

    <button type="submit">Submit</button>
    <button type="button" onclick="resetForm()">Reset</button>
  </form>

  {% if result %}
    <div class="result-container" id="result">{{ result }}</div>
    <div class="btn-group">
      <button onclick="copyResult()">üìã Copy to Clipboard</button>
      <button onclick="downloadResult()">üíæ Download .ff</button>
    </div>
  {% endif %}

  <hr>

  <p><strong>Action Legend:</strong></p>
  <ul>
    <li><strong>Generate</strong>: Provide business rules and inputs ‚Üí Get a new formula.</li>
    <li><strong>Modify</strong>: Paste a formula + describe what to change.</li>
    <li><strong>Explain</strong>: Paste a formula ‚Üí Get plain-English explanation.</li>
    <li><strong>Validate</strong>: Paste a formula ‚Üí Get QA feedback + fixes.</li>
  </ul>

  <div id="historySection" class="history-container"></div>

  <script>
    function loadPreset(action) {
      const logic = document.getElementById("logic");
      const inputs = document.getElementById("inputs");
      const original = document.getElementById("original");

      if (action === "generate") {
        logic.value = `You are an expert in Oracle Cloud HCM Fast Formulas.

Generate a Fast Formula for the Payroll module with the following requirements:

1. If an employee‚Äôs salary is above $120,000, deduct a 3% high-income tax.
2. If the salary is between $80,000 and $120,000, deduct 2% mid-income tax.
3. If the salary is below $80,000, deduct 1% low-income tax.
4. Additionally, if the employee is in the state of California (CA), apply an extra $50 state fee.
5. If the employee‚Äôs job grade is ‚ÄúMGR‚Äù or higher, add a $500 executive bonus.
6. Return the final net pay as:  
   Net Pay = Salary - Taxes - State Fee + Executive Bonus

Include default values for each input.
Make sure the formula returns NET_PAY.
Include inline comments for clarity.`;
        inputs.value = "SALARY (120000), STATE (GA), GRADE (MGR)";
        original.value = "";
      } else if (action === "modify") {
        logic.value = "Change the bonus logic to give an extra 5% to Grade A employees.";
        original.value = "/* Existing bonus formula goes here */";
      } else if (action === "explain" || action === "validate") {
        const sampleFormula = `/* Formula: VACATION_ACCRUAL_COMPLEX_TEST */

DEFAULT FOR PER_ASG_REL_DATE_START IS '1951/01/01 00:00:00' (DATE)
DEFAULT FOR PER_ASG_NORMAL_HOURS IS 40

INPUTS ARE
  IV_HIRE_DATE (DATE),
  IV_EFFECTIVE_DATE (DATE),
  IV_CEILING (NUMBER),
  IV_METHOD (TEXT)

-- Compute Years of Service
yearsOfService = FLOOR(MONTHS_BETWEEN(IV_EFFECTIVE_DATE, IV_HIRE_DATE) / 12)

-- Set base accrual based on years of service
IF yearsOfService < 1 THEN
  baseAccrual = 0
ELSE IF yearsOfService >= 1 AND yearsOfService < 5 THEN
  baseAccrual = 10
ELSE IF yearsOfService >= 5 AND yearsOfService < 10 THEN
  baseAccrual = 15
ELSE
  baseAccrual = 20

-- Adjust for part-time hours
workingHours = PER_ASG_NORMAL_HOURS
standardHours = 40
adjustedAccrual = baseAccrual * (workingHours / standardHours)

-- Enforce ceiling
IF IV_CEILING > 0 AND adjustedAccrual > IV_CEILING THEN
  finalAccrual = IV_CEILING
ELSE
  finalAccrual = adjustedAccrual

-- Optional method override
IF IV_METHOD = 'MANUAL' THEN
  finalAccrual = 0

-- Output
RETURN finalAccrual`;
        original.value = sampleFormula;
        logic.value = "";
        inputs.value = "";
      }
    }

    document.getElementById("ffUpload").addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById("original").value = e.target.result;
      };
      reader.readAsText(file);
    });

    function resetForm() {
      document.getElementById("logic").value = "";
      document.getElementById("inputs").value = "";
      document.getElementById("original").value = "";
      document.getElementById("ffUpload").value = "";
      document.getElementById("action").selectedIndex = 0;
      document.getElementById("model").selectedIndex = 0;
    }

    function copyResult() {
      const resultText = document.getElementById("result").innerText;
      navigator.clipboard.writeText(resultText).then(() => {
        alert("Copied to clipboard!");
      });
    }

    function downloadResult() {
      const resultText = document.getElementById("result").innerText;
      const blob = new Blob([resultText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "fast_formula.ff";
      a.click();
      URL.revokeObjectURL(url);
    }

    async function loadHistory() {
      try {
        const res = await fetch("/static/history.jsonl");
        if (!res.ok) return;
        const text = await res.text();
        const lines = text.trim().split("\n").slice(-10);
        const history = lines.map(line => JSON.parse(line));

        const container = document.getElementById("historySection");
        container.innerHTML = "<h3>üïì Recent Interactions</h3>" +
          history.map(entry => `
            <div class="history-entry">
              <summary>${new Date(entry.timestamp).toLocaleString()} ‚Äî <em>${entry.action}</em></summary>
              <details>
                <summary>Prompt & Response</summary>
                <pre><strong>Prompt:</strong>\n${entry.prompt}</pre>
                <pre><strong>Response:</strong>\n${entry.response}</pre>
              </details>
            </div>
          `).join("");
      } catch (err) {
        console.error("Error loading history:", err);
      }
    }

    window.addEventListener("load", loadHistory);
  </script>
</body>
</html>